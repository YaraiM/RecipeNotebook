<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>レシピ新規作成フォーム</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .recipe-form {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .remove-btn {
      cursor: pointer;
    }
  </style>
</head>
<body class="py-5">
<div class="container">
  <h1 class="text-center mb-4">レシピ新規作成フォーム</h1>
  <div class="recipe-form p-4">
    <form th:action="@{/recipes/new/validate-input}" th:object="${recipeDetailInput}" method="post"
          id="recipeForm">
      <div class="mb-3">
        <label for="name" class="form-label">レシピ名（必須）</label>
        <input type="text" class="form-control" id="name" th:field="*{recipe.name}" required/>
      </div>
      <div class="mb-3">
        <label for="imagePath" class="form-label">レシピ画像</label>
        <input type="text" class="form-control" id="imagePath" th:field="*{recipe.imagePath}"/>
      </div>
      <div class="mb-3">
        <label for="recipeSource" class="form-label">レシピ情報元</label>
        <input type="text" class="form-control" id="recipeSource"
               th:field="*{recipe.recipeSource}"/>
      </div>
      <div class="mb-3">
        <label for="servings" class="form-label">何人分</label>
        <input type="text" class="form-control" id="servings" th:field="*{recipe.servings}"/>
      </div>
      <div class="mb-3">
        <label for="remark" class="form-label">備考</label>
        <input type="text" class="form-control" id="remark" th:field="*{recipe.remark}"/>
      </div>
      <div class="mb-3 form-check">
        <input class="form-check-input" id="favorite" type="checkbox"
               th:checked="*{recipe.favorite}"/>
        <label class="form-check-label" for="favorite">お気に入り</label>
      </div>
      <hr>
      <h4 class="mt-4 mb-3">材料
        <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredient">材料を追加
        </button>
      </h4>
      <div id="ingredientsContainer">
        <!-- 材料フィールドはここへ動的に追加 -->
      </div>
      <hr>
      <h4 class="mt-4 mb-3">調理手順
        <button type="button" class="btn btn-sm btn-outline-primary" id="addInstruction">
          手順を追加
        </button>
      </h4>
      <div id="instructionsContainer">
        <!-- 調理手順フィールドはここへ動的に追加 -->
      </div>
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">入力内容を確認</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let ingredientIndex = 0;
    let instructionIndex = 0;

    function addIngredient() {
      const container = document.getElementById('ingredientsContainer');
      const newIngredient = document.createElement('div');
      newIngredient.classList.add('ingredient-item', 'mb-3');
      newIngredient.innerHTML = `
        <div class="row">
          <div class="col-md-5">
            <input type="text" class="form-control" name="ingredients[${ingredientIndex}].name" placeholder="材料名" required/>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" name="ingredients[${ingredientIndex}].quantity" placeholder="分量"/>
          </div>
          <div class="col-md-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="ingredients[${ingredientIndex}].arrange" id="ingredientArrange${ingredientIndex}"/>
              <label class="form-check-label" for="ingredientArrange${ingredientIndex}">アレンジ</label>
            </div>
          </div>
          <div class="col-md-1">
            <span class="btn btn-sm btn-outline-danger remove-btn">&times;</span>
          </div>
        </div>
      `;
      container.appendChild(newIngredient);
      ingredientIndex++;
    }

      function addInstruction() {
        const container = document.getElementById('instructionsContainer');
        const newInstruction = document.createElement('div');
        newInstruction.classList.add('instruction-item', 'mb-3');
        newInstruction.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-1">
              <span class="step-number"></span>
              <input type="hidden" name="instructions[${instructionIndex}].stepNumber" class="step-number-input">
            </div>
            <div class="col-md-9">
              <textarea class="form-control" name="instructions[${instructionIndex}].content" placeholder="調理手順" required rows="2"></textarea>
            </div>
            <div class="col-md-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="instructions[${instructionIndex}].arrange" id="instructionArrange${instructionIndex}"/>
                <label class="form-check-label" for="instructionArrange${instructionIndex}">アレンジ</label>
              </div>
            </div>
            <div class="col-md-1">
              <span class="btn btn-sm btn-outline-danger remove-btn">&times;</span>
            </div>
          </div>
        `;
        container.appendChild(newInstruction);
        instructionIndex++;
        updateStepNumbers();
      }

      function updateStepNumbers() {
        const steps = document.querySelectorAll('#instructionsContainer .instruction-item');
        steps.forEach((step, index) => {
          const stepNumber = index + 1;
          const stepNumberSpan = step.querySelector('.step-number');
          const stepNumberInput = step.querySelector('.step-number-input');
          stepNumberSpan.textContent = stepNumber + '.';
          stepNumberInput.value = stepNumber;
          stepNumberInput.name = `instructions[${index}].stepNumber`;
          const contentTextarea = step.querySelector('textarea');
          contentTextarea.name = `instructions[${index}].content`;
          const arrangeCheckbox = step.querySelector('input[type="checkbox"]');
          arrangeCheckbox.name = `instructions[${index}].arrange`;
          arrangeCheckbox.id = `instructionArrange${index}`;
          step.querySelector('label').setAttribute('for', `instructionArrange${index}`);
        });
      }

      document.getElementById('addIngredient').addEventListener('click', addIngredient);
      document.getElementById('addInstruction').addEventListener('click', addInstruction);

      document.getElementById('recipeForm').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn')) {
          e.target.closest('.ingredient-item, .instruction-item').remove();
          if (e.target.closest('.instruction-item')) {
            updateStepNumbers();
          }
        }
      });

    // 初期フィールド
    addIngredient();
    addInstruction();
  });
</script>
</body>
</html>
